<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Studio Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 2rem;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
            pointer-events: none;
        }

        .sidebar-content {
            position: relative;
            z-index: 1;
        }

        .sidebar h2 {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            font-size: 1.5rem;
            text-align: center;
            position: relative;
        }

        .sidebar h2::before {
            content: 'ðŸ“·';
            display: block;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .nav-item {
            padding: 1rem 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(255,255,255,0.15);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .nav-item i {
            font-size: 1.2rem;
            width: 20px;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            background: rgba(255,255,255,0.1);
        }

        .header {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,249,250,0.9) 100%);
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .content-area {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,249,250,0.9) 100%);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(248,249,250,0.9) 100%);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.3);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            color: #666;
            margin-bottom: 1rem;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            background: rgba(255,255,255,0.8);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            margin-right: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .edit-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .delete-btn {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        .delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        #logout-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
        }

        #logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
        }

        .settings-form {
            max-width: 500px;
            margin-top: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            color: #d63031;
        }

        .status-confirmed {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }

        .status-completed {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
        }

        .status-cancelled {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
        }

        .payment-pending {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            color: #d63031;
        }

        .payment-completed {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
        }

        .payment-failed {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
        }

        .payment-refunded {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            color: white;
        }

        .payment-partial {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
        }

        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                padding: 1rem;
            }
            
            .main-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="sidebar">
            <div class="sidebar-content">
                <h2>Studio Pro Admin</h2>
                <div class="nav-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </div>
                <div class="nav-item" data-section="users">
                    <i class="fas fa-users"></i>
                    Users
                </div>
                <div class="nav-item" data-section="bookings">
                    <i class="fas fa-calendar-alt"></i>
                    Bookings
                </div>
                <div class="nav-item" data-section="payments">
                    <i class="fas fa-credit-card"></i>
                    Payments
                </div>
                <div class="nav-item" data-section="contacts">
                    <i class="fas fa-envelope"></i>
                    Contacts
                </div>
                <div class="nav-item" data-section="gallery">
                    <i class="fas fa-images"></i>
                    Gallery
                </div>
                <div class="nav-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    Settings
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <h1>Dashboard</h1>
                <button id="logout-btn">Logout</button>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>Total Users</h3>
                    <div class="number" id="total-users">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <h3>Total Bookings</h3>
                    <div class="number" id="total-bookings">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <h3>Total Contacts</h3>
                    <div class="number" id="total-contacts">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-images"></i>
                    </div>
                    <h3>Gallery Items</h3>
                    <div class="number" id="total-gallery">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <h3>Total Revenue</h3>
                    <div class="number" id="total-revenue">$0</div>
                </div>
            </div>

            <div class="content-area">
                <div id="dashboard-section">
                    <h2>Recent Activity</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="activity-table">
                            <!-- Activity data will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div id="users-section" style="display: none;">
                    <h2>Users Management</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Join Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table">
                            <!-- Users data will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div id="bookings-section" style="display: none;">
                    <h2>Bookings Management</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Event Type</th>
                                <th>Total Amount</th>
                                <th>Advance Paid</th>
                                <th>Remaining</th>
                                <th>Payment Status</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bookings-table">
                            <!-- Bookings data will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div id="payments-section" style="display: none;">
                    <h2>Payments Management</h2>
                    
                    <div class="dashboard-stats" style="margin-bottom: 2rem;">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                            </div>
                            <h3>Completed Payments</h3>
                            <div class="number" id="completed-payments">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-clock" style="color: #FF9800;"></i>
                            </div>
                            <h3>Pending Payments</h3>
                            <div class="number" id="pending-payments">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign" style="color: #2196F3;"></i>
                            </div>
                            <h3>Total Revenue</h3>
                            <div class="number" id="payment-revenue">$0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-exclamation-triangle" style="color: #f44336;"></i>
                            </div>
                            <h3>Failed Payments</h3>
                            <div class="number" id="failed-payments">0</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Payment ID</th>
                                <th>User</th>
                                <th>Booking</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="payments-table">
                            <!-- Payments data will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div id="contacts-section" style="display: none;">
                    <h2>Contacts Management</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Message</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="contacts-table">
                            <!-- Contacts data will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div id="gallery-section" style="display: none;">
                    <h2>Gallery Management</h2>
                    
                    <div class="gallery-upload-section" style="margin-bottom: 2rem;">
                        <div class="upload-area" style="border: 2px dashed #667eea; border-radius: 15px; padding: 2rem; text-align: center; background: rgba(102, 126, 234, 0.1); cursor: pointer; transition: all 0.3s ease;">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;"></i>
                            <p style="font-size: 1.2rem; margin-bottom: 1rem;">Drop images here or click to upload</p>
                            <input type="file" id="gallery-upload" multiple accept="image/*" style="display: none;">
                            <button class="action-btn edit-btn" onclick="document.getElementById('gallery-upload').click()">Choose Images</button>
                        </div>
                    </div>
                    
                    <div class="gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;" id="gallery-items">
                        <!-- Gallery items will be populated here -->
                    </div>
                </div>

                <div id="settings-section" style="display: none;">
                    <h2>Settings</h2>
                    <div class="settings-form">
                        <h3>Change Password</h3>
                        <form id="change-password-form">
                            <div class="form-group">
                                <label>Current Password:</label>
                                <input type="password" name="currentPassword" required>
                            </div>
                            <div class="form-group">
                                <label>New Password:</label>
                                <input type="password" name="newPassword" required>
                            </div>
                            <div class="form-group">
                                <label>Confirm New Password:</label>
                                <input type="password" name="confirmPassword" required>
                            </div>
                            <button type="submit" class="action-btn edit-btn">Update Password</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check for admin authentication
        const adminToken = localStorage.getItem('adminToken');
        if (!adminToken) {
            window.location.href = 'admin.html';
        }

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('adminToken');
            window.location.href = 'admin.html';
        });

        // Fetch dashboard data
        async function fetchDashboardData() {
            try {
                const headers = {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                };

                // Fetch statistics
                const [usersRes, bookingsRes, contactsRes, galleryRes, paymentsRes] = await Promise.all([
                    fetch('http://localhost:5000/api/admin/stats/users', { headers }),
                    fetch('http://localhost:5000/api/admin/stats/bookings', { headers }),
                    fetch('http://localhost:5000/api/admin/stats/contacts', { headers }),
                    fetch('http://localhost:5000/api/admin/stats/gallery', { headers }),
                    fetch('http://localhost:5000/api/admin/stats/payments', { headers })
                ]);

                const [usersData, bookingsData, contactsData, galleryData, paymentsData] = await Promise.all([
                    usersRes.json(),
                    bookingsRes.json(),
                    contactsRes.json(),
                    galleryRes.json(),
                    paymentsRes.json()
                ]);

                // Update statistics
                document.getElementById('total-users').textContent = usersData.count || 0;
                document.getElementById('total-bookings').textContent = bookingsData.count || 0;
                document.getElementById('total-contacts').textContent = contactsData.count || 0;
                document.getElementById('total-gallery').textContent = galleryData.count || 0;
                document.getElementById('total-revenue').textContent = `$${(paymentsData.totalRevenue || 0).toFixed(2)}`;

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
            }
        }

        // Navigation functionality
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.getAttribute('data-section');
                
                // Remove active class from all items
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                // Add active class to clicked item
                item.classList.add('active');
                
                // Hide all sections
                document.querySelectorAll('[id$="-section"]').forEach(s => s.style.display = 'none');
                // Show selected section
                document.getElementById(section + '-section').style.display = 'block';
                
                // Update header title
                document.querySelector('.header h1').textContent = item.textContent.trim();
                
                // Load section data
                loadSectionData(section);
            });
        });

        // Load section-specific data
        async function loadSectionData(section) {
            const headers = {
                'Authorization': `Bearer ${adminToken}`,
                'Content-Type': 'application/json'
            };

            try {
                switch(section) {
                    case 'users':
                        const usersRes = await fetch('http://localhost:5000/api/admin/users', { headers });
                        const users = await usersRes.json();
                        displayUsers(users);
                        break;
                    
                    case 'bookings':
                        const bookingsRes = await fetch('http://localhost:5000/api/admin/bookings', { headers });
                        const bookings = await bookingsRes.json();
                        displayBookings(bookings);
                        break;
                    
                    case 'payments':
                        const paymentsRes = await fetch('http://localhost:5000/api/admin/payments', { headers });
                        const payments = await paymentsRes.json();
                        displayPayments(payments);
                        await loadPaymentStats();
                        break;
                    
                    case 'contacts':
                        const contactsRes = await fetch('http://localhost:5000/api/admin/contacts', { headers });
                        const contacts = await contactsRes.json();
                        displayContacts(contacts);
                        break;
                    
                    case 'gallery':
                        loadGalleryItems();
                        break;
                }
            } catch (error) {
                console.error('Error loading section data:', error);
            }
        }

        // Display users in table
        function displayUsers(users) {
            const tbody = document.getElementById('users-table');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name || 'N/A'}</td>
                    <td>${user.email}</td>
                    <td>${user.phone || 'N/A'}</td>
                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="action-btn edit-btn" onclick="editUser('${user._id}')">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteUser('${user._id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Display bookings in table
        function displayBookings(bookings) {
            const tbody = document.getElementById('bookings-table');
            tbody.innerHTML = bookings.map(booking => {
                const totalAmount = booking.totalAmount || booking.price || 0;
                const advanceAmount = booking.advanceAmount || 0;
                const remainingAmount = totalAmount - advanceAmount;
                
                return `
                <tr>
                    <td>${booking.userId ? booking.userId.name : 'N/A'}</td>
                    <td>${new Date(booking.eventDate || booking.date).toLocaleDateString()}</td>
                    <td>${booking.eventTime || booking.time}</td>
                    <td>${booking.eventType || booking.sessionType}</td>
                    <td>$${totalAmount.toFixed(2)}</td>
                    <td>$${advanceAmount.toFixed(2)}</td>
                    <td>$${remainingAmount.toFixed(2)}</td>
                    <td>
                        <span class="status-badge payment-${booking.paymentStatus || 'pending'}">
                            ${(booking.paymentStatus || 'pending').toUpperCase()}
                        </span>
                    </td>
                    <td>
                        <select onchange="updateBookingStatus('${booking._id}', this.value)" class="status-${booking.status}">
                            <option value="pending" ${booking.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                            <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <button class="action-btn edit-btn" onclick="viewBookingPayments('${booking._id}')">View Payments</button>
                        <button class="action-btn delete-btn" onclick="deleteBooking('${booking._id}')">Delete</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // Display contacts in table
        function displayContacts(contacts) {
            const tbody = document.getElementById('contacts-table');
            tbody.innerHTML = contacts.map(contact => `
                <tr>
                    <td>${contact.name}</td>
                    <td>${contact.email}</td>
                    <td>${contact.phone}</td>
                    <td title="${contact.message}">${contact.message.length > 50 ? contact.message.substring(0, 50) + '...' : contact.message}</td>
                    <td>${new Date(contact.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="action-btn delete-btn" onclick="deleteContact('${contact._id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Update booking status
        async function updateBookingStatus(bookingId, status) {
            try {
                const response = await fetch(`http://localhost:5000/api/admin/bookings/${bookingId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    alert('Booking status updated successfully');
                    loadSectionData('bookings'); // Reload bookings
                } else {
                    alert('Failed to update booking status');
                }
            } catch (error) {
                console.error('Error updating booking status:', error);
                alert('Error updating booking status');
            }
        }

        // Delete booking
        async function deleteBooking(bookingId) {
            if (!confirm('Are you sure you want to delete this booking?')) return;

            try {
                const response = await fetch(`http://localhost:5000/api/admin/bookings/${bookingId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('Booking deleted successfully');
                    loadSectionData('bookings'); // Reload bookings
                    fetchDashboardData(); // Update stats
                } else {
                    alert('Failed to delete booking');
                }
            } catch (error) {
                console.error('Error deleting booking:', error);
                alert('Error deleting booking');
            }
        }

        // Delete contact
        async function deleteContact(contactId) {
            if (!confirm('Are you sure you want to delete this contact?')) return;

            try {
                const response = await fetch(`http://localhost:5000/api/admin/contacts/${contactId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    alert('Contact deleted successfully');
                    loadSectionData('contacts'); // Reload contacts
                    fetchDashboardData(); // Update stats
                } else {
                    alert('Failed to delete contact');
                }
            } catch (error) {
                console.error('Error deleting contact:', error);
                alert('Error deleting contact');
            }
        }

        // Display payments in table
        function displayPayments(payments) {
            const tbody = document.getElementById('payments-table');
            tbody.innerHTML = payments.map(payment => `
                <tr>
                    <td title="${payment.paymentId}">${payment.paymentId.substring(0, 15)}...</td>
                    <td>${payment.userId ? payment.userId.name : 'N/A'}</td>
                    <td>${payment.bookingId ? payment.bookingId.name || 'Booking' : 'N/A'}</td>
                    <td>$${payment.amount.toFixed(2)}</td>
                    <td>
                        <span class="status-badge">
                            ${payment.method.toUpperCase()}
                        </span>
                        ${payment.cardDetails ? `<br><small>**** ${payment.cardDetails.last4}</small>` : ''}
                    </td>
                    <td>
                        <span class="status-badge payment-${payment.status}">
                            ${payment.status.toUpperCase()}
                        </span>
                    </td>
                    <td>${new Date(payment.createdAt).toLocaleDateString()}</td>
                    <td>
                        ${payment.status === 'completed' ? 
                            `<button class="action-btn delete-btn" onclick="processRefund('${payment._id}')">Refund</button>` : 
                            payment.status === 'pending' ? 
                            `<button class="action-btn edit-btn" onclick="updatePaymentStatus('${payment._id}', 'completed')">Mark Paid</button>
                             <button class="action-btn delete-btn" onclick="updatePaymentStatus('${payment._id}', 'failed')">Mark Failed</button>` :
                            `<button class="action-btn edit-btn" onclick="viewPaymentDetails('${payment._id}')">View Details</button>`
                        }
                    </td>
                </tr>
            `).join('');
        }

        // Load payment statistics
        async function loadPaymentStats() {
            try {
                const headers = {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                };

                const response = await fetch('http://localhost:5000/api/admin/stats/payments', { headers });
                const stats = await response.json();

                document.getElementById('completed-payments').textContent = stats.completedPayments || 0;
                document.getElementById('pending-payments').textContent = (stats.totalPayments - stats.completedPayments) || 0;
                document.getElementById('payment-revenue').textContent = `$${(stats.totalRevenue || 0).toFixed(2)}`;
                document.getElementById('failed-payments').textContent = stats.failedPayments || 0;

            } catch (error) {
                console.error('Error loading payment stats:', error);
            }
        }

        // View booking payments
        async function viewBookingPayments(bookingId) {
            try {
                const headers = {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                };

                const response = await fetch(`http://localhost:5000/api/admin/payments?bookingId=${bookingId}`, { headers });
                const payments = await response.json();

                let paymentDetails = payments.map(payment => 
                    `Payment ID: ${payment.paymentId}\n` +
                    `Amount: $${payment.amount.toFixed(2)}\n` +
                    `Status: ${payment.status}\n` +
                    `Method: ${payment.method}\n` +
                    `Date: ${new Date(payment.createdAt).toLocaleDateString()}\n`
                ).join('\n---\n');

                alert(paymentDetails || 'No payments found for this booking.');
            } catch (error) {
                console.error('Error fetching booking payments:', error);
                alert('Error loading payment information.');
            }
        }

        // Update payment status
        async function updatePaymentStatus(paymentId, status) {
            try {
                const headers = {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                };

                const response = await fetch(`http://localhost:5000/api/admin/payments/${paymentId}/status`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    alert('Payment status updated successfully');
                    loadSectionData('payments'); // Reload payments
                    fetchDashboardData(); // Update stats
                } else {
                    alert('Failed to update payment status');
                }
            } catch (error) {
                console.error('Error updating payment status:', error);
                alert('Error updating payment status');
            }
        }

        // Process refund
        async function processRefund(paymentId) {
            const refundReason = prompt('Enter refund reason:');
            if (!refundReason) return;

            try {
                const headers = {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                };

                const response = await fetch(`http://localhost:5000/api/admin/payments/${paymentId}/refund`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ refundReason })
                });

                if (response.ok) {
                    alert('Refund processed successfully');
                    loadSectionData('payments'); // Reload payments
                    fetchDashboardData(); // Update stats
                } else {
                    const error = await response.json();
                    alert(`Failed to process refund: ${error.message}`);
                }
            } catch (error) {
                console.error('Error processing refund:', error);
                alert('Error processing refund');
            }
        }

        // View payment details
        async function viewPaymentDetails(paymentId) {
            try {
                const headers = {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                };

                const response = await fetch(`http://localhost:5000/api/admin/payments/${paymentId}`, { headers });
                const payment = await response.json();

                const details = `
                Payment ID: ${payment.paymentId}
                Transaction ID: ${payment.transactionId}
                Amount: $${payment.amount.toFixed(2)}
                Method: ${payment.method}
                Status: ${payment.status}
                Date: ${new Date(payment.createdAt).toLocaleString()}
                ${payment.description ? `\nDescription: ${payment.description}` : ''}
                ${payment.failureReason ? `\nFailure Reason: ${payment.failureReason}` : ''}
                ${payment.refundReason ? `\nRefund Reason: ${payment.refundReason}` : ''}
                `;

                alert(details);
            } catch (error) {
                console.error('Error fetching payment details:', error);
                alert('Error loading payment details');
            }
        }

        // Password change form
        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const currentPassword = formData.get('currentPassword');
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');
            
            if (newPassword !== confirmPassword) {
                alert('New passwords do not match');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:5000/api/admin/change-password', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Password updated successfully');
                    e.target.reset();
                } else {
                    alert(data.message || 'Failed to update password');
                }
            } catch (error) {
                console.error('Error updating password:', error);
                alert('Error updating password');
            }
        });

        // Initial load
        fetchDashboardData();
        
        // Gallery Management Functions
        async function loadGalleryItems() {
            try {
                console.log('Loading gallery items...');
                console.log('Admin token:', adminToken ? 'Present' : 'Missing');
                
                // Show loading state
                const galleryGrid = document.getElementById('gallery-items');
                galleryGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i><br>Loading gallery items...</div>';
                
                const headers = {
                    'Authorization': `Bearer ${adminToken}`,
                    'Content-Type': 'application/json'
                };
                
                console.log('Making request to:', 'http://localhost:5000/api/gallery');
                
                const response = await fetch('http://localhost:5000/api/gallery', { headers });
                
                console.log('Gallery response status:', response.status);
                
                if (response.ok) {
                    const galleryItems = await response.json();
                    console.log('Gallery items loaded:', galleryItems.length, 'items');
                    
                    if (galleryItems.length > 0) {
                        displayGalleryItems(galleryItems);
                    } else {
                        galleryGrid.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;"><i class="fas fa-images" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i><br>No gallery items found. Upload your first image!</div>';
                    }
                } else if (response.status === 401) {
                    console.error('Authentication failed for gallery items');
                    localStorage.removeItem('adminToken');
                    window.location.href = 'admin.html';
                } else {
                    console.error('Failed to load gallery items:', response.status, response.statusText);
                    displayPlaceholderImages();
                }
            } catch (error) {
                console.error('Error loading gallery items:', error);
                // Show AI-generated placeholder images
                displayPlaceholderImages();
            }
        }
        
        function displayGalleryItems(items) {
            console.log('Displaying gallery items:', items.length);
            const galleryGrid = document.getElementById('gallery-items');
            
            galleryGrid.innerHTML = items.map(item => {
                console.log('Gallery item:', item.title, 'URL:', item.imageUrl);
                return `
                <div class="gallery-item" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease;">
                    <img src="http://localhost:5000${item.imageUrl}" 
                         alt="${item.title}" 
                         style="width: 100%; height: 150px; object-fit: cover;" 
                         onerror="console.error('Image failed to load:', this.src); this.src='https://via.placeholder.com/200x150?text=Image+Not+Found';"
                         onload="console.log('Image loaded successfully:', this.src);">
                    <div style="padding: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem;">${item.title}</h4>
                        <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">${item.description || 'No description'}</p>
                        <p style="font-size: 0.7rem; color: #999; margin-bottom: 1rem;">Category: ${item.category || 'N/A'}</p>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="action-btn edit-btn" onclick="editGalleryItem('${item._id}')">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteGalleryItem('${item._id}')">Delete</button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
        
        function displayPlaceholderImages() {
            const aiImages = [
                {
                    url: 'https://images.unsplash.com/photo-1542038784456-1ea8e935640e?w=400&h=300&fit=crop',
                    title: 'Studio Setup',
                    description: 'Professional photography studio with lighting equipment'
                },
                {
                    url: 'https://images.unsplash.com/photo-1554048612-b6a482b55e84?w=400&h=300&fit=crop',
                    title: 'Camera Equipment',
                    description: 'High-end camera and lens setup for professional photography'
                },
                {
                    url: 'https://images.unsplash.com/photo-1609902726285-00668009f004?w=400&h=300&fit=crop',
                    title: 'Photography Session',
                    description: 'Behind the scenes of a professional photo shoot'
                },
                {
                    url: 'https://images.unsplash.com/photo-1583939003579-730e3918a45a?w=400&h=300&fit=crop',
                    title: 'Wedding Photography',
                    description: 'Beautiful wedding moments captured professionally'
                },
                {
                    url: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=400&h=300&fit=crop',
                    title: 'Portrait Photography',
                    description: 'Professional portrait session with perfect lighting'
                },
                {
                    url: 'https://images.unsplash.com/photo-1511578314322-379afb476865?w=400&h=300&fit=crop',
                    title: 'Event Photography',
                    description: 'Capturing special moments at events and celebrations'
                }
            ];
            
            const galleryGrid = document.getElementById('gallery-items');
            galleryGrid.innerHTML = aiImages.map((item, index) => `
                <div class="gallery-item" style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 10px 25px rgba(0,0,0,0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 5px 15px rgba(0,0,0,0.1)'">
                    <img src="${item.url}" alt="${item.title}" style="width: 100%; height: 150px; object-fit: cover;">
                    <div style="padding: 1rem;">
                        <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: #333;">${item.title}</h4>
                        <p style="font-size: 0.8rem; color: #666; margin-bottom: 1rem;">${item.description}</p>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="action-btn edit-btn" onclick="editGalleryItem('ai-${index}')">Edit</button>
                            <button class="action-btn delete-btn" onclick="deleteGalleryItem('ai-${index}')">Remove</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Gallery upload functionality
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.querySelector('.upload-area');
            const fileInput = document.getElementById('gallery-upload');
            
            if (uploadArea && fileInput) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#ff6b6b';
                    uploadArea.style.background = 'rgba(255, 107, 107, 0.1)';
                });
                
                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#667eea';
                    uploadArea.style.background = 'rgba(102, 126, 234, 0.1)';
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#667eea';
                    uploadArea.style.background = 'rgba(102, 126, 234, 0.1)';
                    
                    const files = e.dataTransfer.files;
                    handleFileUpload(files);
                });
                
                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });
                
                fileInput.addEventListener('change', (e) => {
                    handleFileUpload(e.target.files);
                });
            }
        });
        
        async function handleFileUpload(files) {
            const uploadArea = document.querySelector('.upload-area');
            const originalContent = uploadArea.innerHTML;
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    try {
                        console.log('Uploading file:', file.name, 'Size:', file.size, 'Type:', file.type);
                        console.log('Admin token:', adminToken ? 'Present' : 'Missing');
                        
                        // Show uploading state
                        uploadArea.innerHTML = `
                            <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #667eea; margin-bottom: 1rem;"></i>
                            <p style="font-size: 1.2rem; margin-bottom: 1rem;">Uploading ${file.name}...</p>
                        `;
                        
                        const formData = new FormData();
                        formData.append('image', file);
                        formData.append('title', file.name.split('.')[0]);
                        formData.append('description', 'Uploaded via admin panel');
                        formData.append('category', 'portfolio');
                        
                        console.log('FormData prepared, making request to:', 'http://localhost:5000/api/gallery/upload');
                        
                        const response = await fetch('http://localhost:5000/api/gallery/upload', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${adminToken}`
                            },
                            body: formData
                        });
                        
                        console.log('Response status:', response.status);
                        console.log('Response headers:', response.headers);
                        
                        if (response.ok) {
                            const result = await response.json();
                            console.log('Upload successful:', result);
                            
                            // Show success state temporarily
                            uploadArea.innerHTML = `
                                <i class="fas fa-check-circle" style="font-size: 3rem; color: #4CAF50; margin-bottom: 1rem;"></i>
                                <p style="font-size: 1.2rem; margin-bottom: 1rem; color: #4CAF50;">Upload successful!</p>
                            `;
                            
                            // Restore original content after 2 seconds
                            setTimeout(() => {
                                uploadArea.innerHTML = originalContent;
                            }, 2000);
                            
                            loadGalleryItems(); // Reload gallery
                            fetchDashboardData(); // Update stats
                        } else {
                            const errorData = await response.json();
                            console.error('Upload failed:', {
                                status: response.status,
                                statusText: response.statusText,
                                error: errorData
                            });
                            
                            let errorMessage = 'Upload failed';
                            if (response.status === 401) {
                                errorMessage = 'Authentication failed. Please login again.';
                                // Redirect to login if token is invalid
                                localStorage.removeItem('adminToken');
                                window.location.href = 'admin.html';
                                return;
                            } else if (response.status === 403) {
                                errorMessage = 'Admin access required.';
                            } else if (errorData && errorData.message) {
                                errorMessage = errorData.message;
                            }
                            
                            alert(`Upload failed: ${errorMessage}`);
                            uploadArea.innerHTML = originalContent;
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        alert(`Upload error: ${error.message}. Please check your connection and try again.`);
                        uploadArea.innerHTML = originalContent;
                    }
                } else {
                    alert('Please select only image files.');
                }
            }
        }
        
        async function editGalleryItem(itemId) {
            const newTitle = prompt('Enter new title:');
            if (newTitle) {
                try {
                    const response = await fetch(`http://localhost:5000/api/gallery/${itemId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${adminToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ title: newTitle })
                    });
                    
                    if (response.ok) {
                        loadGalleryItems();
                    } else {
                        alert('Failed to update item');
                    }
                } catch (error) {
                    console.error('Error updating gallery item:', error);
                    alert('Error updating item');
                }
            }
        }
        
        async function deleteGalleryItem(itemId) {
            if (confirm('Are you sure you want to delete this item?')) {
                try {
                    const response = await fetch(`http://localhost:5000/api/gallery/${itemId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${adminToken}`
                        }
                    });
                    
                    if (response.ok || itemId.startsWith('ai-')) {
                        loadGalleryItems();
                        fetchDashboardData(); // Update stats
                    } else {
                        alert('Failed to delete item');
                    }
                } catch (error) {
                    console.error('Error deleting gallery item:', error);
                    alert('Error deleting item');
                }
            }
        }
    </script>
</body>
</html>